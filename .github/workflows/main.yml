name: ðŸš€ VPS Debian z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa uÅ¼ytkownika'
        required: false
        default: 'debian'
      ssh_port:
        description: 'Port SSH'
        required: false
        default: '22'

jobs:
  setup-debian-vps:
    runs-on: debian-12  # Debian 12 Bookworm
    timeout-minutes: 3600

    steps:
      - name: ðŸ”¥ Czyszczenie systemu
        run: |
          # Zatrzymaj wszystkie procesy menedÅ¼era pakietÃ³w
          sudo killall -9 apt apt-get dpkg 2>/dev/null || true
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo rm -f /var/lib/dpkg/lock
          sudo rm -f /var/cache/apt/archives/lock
          
          # Przygotowanie systemu
          sudo dpkg --configure -a
          sudo apt-get update
          sudo apt-get upgrade -y

      - name: ðŸ“¦ Instalacja podstawowych narzÄ™dzi
        run: |
          sudo apt-get install -y \
            openssh-server \
            curl \
            wget \
            git \
            ufw \
            sudo \
            ca-certificates \
            gnupg \
            lsb-release \
            htop \
            neofetch

      - name: ðŸ”§ Konfiguracja SSH
        run: |
          # Backup konfiguracji
          sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
          
          # Konfiguracja SSH
          sudo sed -i 's/#Port 22/Port ${{ github.event.inputs.ssh_port }}/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
          
          # Restart SSH
          sudo systemctl restart sshd

      - name: ðŸ‘¤ Tworzenie uÅ¼ytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          PASSWORD=$(openssl rand -base64 16 | tr -dc 'a-zA-Z0-9' | head -c16)
          
          # Tworzenie uÅ¼ytkownika
          sudo useradd -m -s /bin/bash -G sudo $USERNAME 2>/dev/null || sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: ðŸ”‘ Generowanie kluczy SSH
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Tworzenie katalogu .ssh
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo chmod 700 /home/$USERNAME/.ssh
          
          # Generowanie kluczy (RSA i ED25519)
          sudo ssh-keygen -t rsa -b 4096 -f /home/$USERNAME/.ssh/id_rsa -N "" -q
          sudo ssh-keygen -t ed25519 -f /home/$USERNAME/.ssh/id_ed25519 -N "" -q
          
          # Autoryzacja
          sudo cat /home/$USERNAME/.ssh/id_rsa.pub > /home/$USERNAME/.ssh/authorized_keys
          sudo cat /home/$USERNAME/.ssh/id_ed25519.pub >> /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

      - name: ðŸ”¥ Konfiguracja firewalla
        run: |
          # Reset UFW
          sudo ufw --force reset || true
          
          # Podstawowe reguÅ‚y
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow ${{ github.event.inputs.ssh_port }}/tcp
          
          # WÅ‚Ä…cz UFW
          echo "y" | sudo ufw enable
          sudo ufw status verbose

      - name: ðŸ“ Tworzenie struktury katalogÃ³w
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          sudo mkdir -p /var/www/html
          sudo mkdir -p /opt/scripts
          sudo mkdir -p /backups
          sudo chown -R $USERNAME:$USERNAME /var/www /opt /backups 2>/dev/null || true

      - name: ðŸ“¦ Instalacja Tailscale
        run: |
          # Instalacja Tailscale na Debian
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # PodÅ‚Ä…czenie do Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=debian-vps-${{ github.run_id }} \
            --accept-routes=false \
            --accept-dns=false
          
          # Czekaj na IP
          for i in {1..15}; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TAILSCALE_IP" ]; then
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              echo "âœ… Tailscale IP: $TAILSCALE_IP"
              break
            fi
            echo "Oczekiwanie na Tailscale IP... ($i/15)"
            sleep 3
          done

      - name: ðŸ“‹ WyÅ›wietl dane dostÄ™powe
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me || echo "Nieznany")
          
          echo "================================================"
          echo "    ðŸš€ DEBIAN 12 Z TAILSCALE GOTOWY           "
          echo "================================================"
          echo ""
          echo "ðŸ“Œ DANE SERWERA:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸ–¥ï¸  System: Debian 12 (Bookworm)"
          echo "ðŸ”— Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "ðŸŒ Publiczny IP: $PUBLIC_IP"
          echo ""
          echo "ðŸ‘¤ DANE UÅ»YTKOWNIKA:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "UÅ¼ytkownik: ${{ env.VPS_USERNAME }}"
          echo "HasÅ‚o: ${{ env.VPS_PASSWORD }}"
          echo "Port SSH: ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ðŸ”§ KOMENDY DO POÅÄ„CZENIA:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸ“¡ PRZEZ TAILSCALE:"
          echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ðŸ”‘ KLUCZE PRYWATNE SSH:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ðŸ” KLUCZ RSA:"
          echo "------------------"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_rsa
          echo ""
          echo "ðŸ” KLUCZ ED25519 (nowszy):"
          echo "------------------"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_ed25519
          echo ""
          echo "================================================"
          echo "âœ… Debian aktywny przez 60 godzin!"
          echo "================================================"

      - name: ðŸ”„ Utrzymywanie poÅ‚Ä…czenia
        run: |
          echo "â³ Debian VPS aktywny przez 60 godzin"
          echo ""
          
          while true; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "${{ env.TAILSCALE_IP }}")
            UPTIME=$(uptime | awk '{print $3}' | tr -d ',')
            
            echo "[$(date)] âœ… Debian 12 | Uptime: $UPTIME"
            echo "   Tailscale: $TAILSCALE_IP"
            echo "   ssh ${{ env.VPS_USERNAME }}@$TAILSCALE_IP -p ${{ github.event.inputs.ssh_port }}"
            echo "   HasÅ‚o: ${{ env.VPS_PASSWORD }}"
            echo "   ---"
            sleep 300
          done

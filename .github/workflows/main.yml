name: VPS Ubuntu z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa u≈ºytkownika'
        required: false
        default: 'ubuntu'
      password:
        description: 'Has≈Ço'
        required: false
        type: string

jobs:
  setup-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 43200  # 30 dni

    steps:
      - name: üì¶ Podstawowa instalacja
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server ufw docker.io docker-compose net-tools curl wget git

      - name: üë§ Tworzenie u≈ºytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          if [[ -z "${{ github.event.inputs.password }}" ]]; then
            PASSWORD=$(openssl rand -base64 12)
          else
            PASSWORD="${{ github.event.inputs.password }}"
          fi
          
          sudo useradd -m -s /bin/bash -G sudo,docker $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: üîë Generowanie kluczy SSH
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo ssh-keygen -t rsa -b 4096 -f /home/$USERNAME/.ssh/id_rsa -N "" -C "$USERNAME@vps"
          sudo cp /home/$USERNAME/.ssh/id_rsa.pub /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

      - name: üî• Konfiguracja firewalla
        run: |
          sudo ufw --force enable
          sudo ufw allow 22/tcp
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp

      - name: üîß Konfiguracja SSH
        run: |
          sudo sed -i 's/#PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart sshd

      - name: üìÅ Katalogi aplikacji
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          sudo mkdir -p /var/www/html
          sudo chown -R $USERNAME:$USERNAME /var/www

      - name: üì¶ Instalacja Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=vps-ubuntu --ssh

      - name: üåê Pobierz IP Tailscale
        run: |
          sleep 10
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "### üñ•Ô∏è DANE DO PO≈ÅƒÑCZENIA ###"
          echo "Tailscale IP: $TAILSCALE_IP"
          echo "U≈ºytkownik: ${{ env.VPS_USERNAME }}"
          echo "Has≈Ço: ${{ env.VPS_PASSWORD }}"
          echo ""
          echo "üîë KLUCZ PRYWATNY SSH:"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_rsa
          echo ""
          echo "üìå Po≈ÇƒÖczenie przez Putty:"
          echo "Host: $TAILSCALE_IP"
          echo "Port: 22"
          echo "Username: ${{ env.VPS_USERNAME }}"
          echo "Password: ${{ env.VPS_PASSWORD }}"
          echo ""
          echo "üìå Po≈ÇƒÖczenie przez SSH:"
          echo "ssh ${{ env.VPS_USERNAME }}@$TAILSCALE_IP"

      - name: üîÑ Utrzymywanie po≈ÇƒÖczenia
        run: |
          echo "================================="
          echo "‚úÖ VPS Ubuntu przez Tailscale"
          echo "================================="
          echo "IP: ${{ env.TAILSCALE_IP }}"
          echo "User: ${{ env.VPS_USERNAME }}"
          echo "Pass: ${{ env.VPS_PASSWORD }}"
          echo "================================="
          echo ""
          echo "Po≈ÇƒÖcz siƒô przez Putty:"
          echo "${{ env.TAILSCALE_IP }}:22"
          echo ""
          
          while true; do
            echo "[$(date)] ‚úÖ Aktywny - IP: ${{ env.TAILSCALE_IP }}"
            sleep 3600
          done

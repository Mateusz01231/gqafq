name: ğŸš€ VPS Ubuntu Podstawowy z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa uÅ¼ytkownika'
        required: false
        default: 'ubuntu'
      ssh_port:
        description: 'Port SSH'
        required: false
        default: '22'

jobs:
  setup-ubuntu-vps:
    runs-on: ubuntu-24.04
    timeout-minutes: 3600

    steps:
      - name: ğŸ”¥ TOTALNY RESET PAKIETÃ“W
        run: |
          # Zabij wszystkie procesy menedÅ¼era pakietÃ³w
          sudo killall -9 apt apt-get dpkg 2>/dev/null || true
          sudo rm -f /var/lib/dpkg/lock-frontend
          sudo rm -f /var/lib/dpkg/lock
          sudo rm -f /var/cache/apt/archives/lock
          
          # Naprawa dpkg
          sudo dpkg --configure -a
          sudo apt-get update --fix-missing
          
          # WymuÅ› instalacjÄ™ podstawowych pakietÃ³w bez zaleÅ¼noÅ›ci
          sudo apt-get install -y --fix-broken
          
          # Minimalna aktualizacja
          sudo apt-get update

      - name: ğŸ“¦ Instalacja TYLKO niezbÄ™dnych pakietÃ³w
        run: |
          # Instalujemy tylko to co naprawdÄ™ potrzebne
          sudo apt-get install -y --no-install-recommends \
            openssh-server \
            curl \
            wget \
            git \
            ufw \
            sudo \
            ca-certificates

      - name: ğŸ”§ Konfiguracja SSH
        run: |
          # Prosta konfiguracja SSH
          sudo sed -i 's/#Port 22/Port ${{ github.event.inputs.ssh_port }}/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart sshd

      - name: ğŸ‘¤ Tworzenie uÅ¼ytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          PASSWORD=$(openssl rand -base64 12 | tr -dc 'a-zA-Z0-9' | head -c12)
          
          # Tworzenie uÅ¼ytkownika
          sudo useradd -m -s /bin/bash -G sudo $USERNAME 2>/dev/null || sudo useradd -m -s /bin/bash $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: ğŸ”‘ Generowanie klucza SSH
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo ssh-keygen -t rsa -b 2048 -f /home/$USERNAME/.ssh/id_rsa -N "" -q
          sudo cp /home/$USERNAME/.ssh/id_rsa.pub /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

      - name: ğŸ”¥ Podstawowy firewall
        run: |
          # Minimalny firewall
          sudo ufw --force enable || true
          sudo ufw allow ${{ github.event.inputs.ssh_port }}/tcp || true

      - name: ğŸ“¦ Instalacja Tailscale (najwaÅ¼niejsze)
        run: |
          # Instalacja Tailscale (to jest najwaÅ¼niejsze)
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # PodÅ‚Ä…czenie do Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=ubuntu-vps-${{ github.run_id }} || true
          
          # Czekaj na IP
          for i in {1..10}; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TAILSCALE_IP" ]; then
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            sleep 3
          done

      - name: ğŸ“‹ WyÅ›wietl dane dostÄ™powe
        run: |
          echo "=========================================="
          echo "  ğŸš€ VPS GOTOWY PRZEZ TAILSCALE  "
          echo "=========================================="
          echo ""
          echo "ğŸ”— Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "ğŸ‘¤ UÅ¼ytkownik: ${{ env.VPS_USERNAME }}"
          echo "ğŸ”‘ HasÅ‚o: ${{ env.VPS_PASSWORD }}"
          echo "ğŸ”Œ Port SSH: ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ğŸ“¡ POÅÄ„CZENIE:"
          echo "ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ğŸ”‘ KLUCZ PRYWATNY:"
          echo "------------------"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_rsa
          echo ""
          echo "=========================================="

      - name: ğŸ”„ Utrzymywanie poÅ‚Ä…czenia
        run: |
          echo "â³ VPS aktywny przez 60 godzin"
          echo ""
          while true; do
            echo "[$(date)] âœ… VPS | Tailscale: ${{ env.TAILSCALE_IP }}"
            echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
            echo "   ---"
            sleep 300
          done

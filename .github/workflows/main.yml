name: ğŸš€ VPS Ubuntu z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa uÅ¼ytkownika'
        required: false
        default: 'ubuntu'
      ssh_port:
        description: 'Port SSH'
        required: false
        default: '22'

jobs:
  setup-ubuntu-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: ğŸ“¦ Instalacja podstawowych narzÄ™dzi
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            openssh-server \
            curl wget git htop \
            ufw fail2ban \
            docker.io docker-compose \
            nodejs npm \
            nginx

      - name: ğŸ”§ Konfiguracja SSH
        run: |
          sudo sed -i 's/#Port 22/Port ${{ github.event.inputs.ssh_port }}/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart sshd

      - name: ğŸ‘¤ Tworzenie uÅ¼ytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          
          sudo useradd -m -s /bin/bash -G sudo,docker $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: ğŸ”‘ Generowanie kluczy SSH
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo ssh-keygen -t rsa -b 4096 -f /home/$USERNAME/.ssh/id_rsa -N "" -C "$USERNAME@vps"
          sudo cp /home/$USERNAME/.ssh/id_rsa.pub /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

      - name: ğŸ”¥ Konfiguracja firewalla
        run: |
          sudo ufw --force enable
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          sudo ufw allow ${{ github.event.inputs.ssh_port }}/tcp
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp

      - name: ğŸ“ Tworzenie katalogÃ³w
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          sudo mkdir -p /var/www /opt /backups
          sudo chown -R $USERNAME:$USERNAME /var/www /opt /backups

      - name: ğŸ“¦ Instalacja Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=github-vps-${{ github.run_id }}
          
          # Czekaj na IP Tailscale
          sleep 10
          TAILSCALE_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV

      - name: ğŸ“‹ WyÅ›wietl dane dostÄ™powe
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me)
          
          echo "========================================="
          echo "    ğŸš€ VPS UBUNTU PRZEZ TAILSCALE     "
          echo "========================================="
          echo ""
          echo "ğŸ“Œ DANE DOSTÄ˜POWE:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ”— Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "ğŸŒ Publiczny IP: $PUBLIC_IP"
          echo "ğŸ‘¤ UÅ¼ytkownik: ${{ env.VPS_USERNAME }}"
          echo "ğŸ”‘ HasÅ‚o: ${{ env.VPS_PASSWORD }}"
          echo "ğŸ”Œ Port SSH: ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ğŸ”§ KOMENDY DO POÅÄ„CZENIA:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          echo "ğŸ“¡ PRZEZ TAILSCALE (zalecane):"
          echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ğŸŒ PRZEZ PUBLICZNY IP:"
          echo "   ssh ${{ env.VPS_USERNAME }}@$PUBLIC_IP -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "ğŸ”‘ KLUCZ PRYWATNY SSH:"
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_rsa
          echo ""
          echo "âœ… Tailscale IP: ${{ env.TAILSCALE_IP }} - zapisz go!"
          echo "========================================="

      - name: ğŸ”„ Utrzymywanie poÅ‚Ä…czenia
        run: |
          echo ""
          echo "âœ… VPS Ubuntu przez Tailscale skonfigurowany!"
          echo "â³ Aktywny przez 60 godzin"
          echo ""
          
          while true; do
            echo "[$(date)] âœ… VPS aktywny - Tailscale IP: ${{ env.TAILSCALE_IP }}"
            echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
            echo "   HasÅ‚o: ${{ env.VPS_PASSWORD }}"
            echo "   ---"
            sleep 300
          done

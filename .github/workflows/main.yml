name: üöÄ VPS Ubuntu 24.04 LTS z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa u≈ºytkownika'
        required: false
        default: 'ubuntu'
      ssh_port:
        description: 'Port SSH'
        required: false
        default: '22'

jobs:
  setup-ubuntu-vps:
    runs-on: ubuntu-24.04  # Najnowsze Ubuntu 24.04
    timeout-minutes: 3600

    steps:
      - name: üì¶ Aktualizacja systemu
        run: |
          sudo apt-get update
          sudo apt-get upgrade -y
          sudo apt-get autoremove -y

      - name: üì¶ Instalacja podstawowych narzƒôdzi
        run: |
          sudo apt-get install -y \
            openssh-server \
            curl wget git htop neofetch \
            ufw fail2ban \
            docker.io docker-compose \
            nodejs npm \
            nginx \
            certbot python3-certbot-nginx \
            build-essential \
            net-tools \
            software-properties-common \
            apt-transport-https \
            ca-certificates \
            gnupg \
            lsb-release \
            unzip \
            zip \
            tmux \
            screen \
            vim \
            nano

      - name: üîß Konfiguracja SSH
        run: |
          # Backup konfiguracji
          sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
          
          # Konfiguracja SSH
          sudo sed -i 's/#Port 22/Port ${{ github.event.inputs.ssh_port }}/' /etc/ssh/sshd_config
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/#MaxAuthTries 6/MaxAuthTries 3/' /etc/ssh/sshd_config
          sudo sed -i 's/#ClientAliveInterval 0/ClientAliveInterval 300/' /etc/ssh/sshd_config
          
          # Restart SSH
          sudo systemctl restart sshd

      - name: üë§ Tworzenie u≈ºytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Generuj losowe has≈Ço (24 znaki)
          PASSWORD=$(openssl rand -base64 32 | tr -d "=+/" | cut -c1-24)
          
          # Tworzenie u≈ºytkownika
          sudo useradd -m -s /bin/bash -G sudo,docker,adm $USERNAME
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          
          # Sudo bez has≈Ça
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          # Zapisz dane
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          
          # Info o ha≈õle
          echo "USER_CREATED=true" >> $GITHUB_ENV

      - name: üîë Generowanie kluczy SSH (ED25519 - nowszy standard)
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Tworzenie katalogu .ssh
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo chmod 700 /home/$USERNAME/.ssh
          
          # Generowanie kluczy (ED25519 - szybszy i bezpieczniejszy ni≈º RSA)
          sudo ssh-keygen -t ed25519 -f /home/$USERNAME/.ssh/id_ed25519 -N "" -C "$USERNAME@ubuntu-24.04"
          
          # Dodanie klucza publicznego do autoryzowanych
          sudo cp /home/$USERNAME/.ssh/id_ed25519.pub /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          
          # Uprawnienia
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh
          
          # Info
          echo "SSH_KEY_GENERATED=true" >> $GITHUB_ENV

      - name: üî• Konfiguracja firewalla (UFW)
        run: |
          # Reset i podstawowa konfiguracja
          sudo ufw --force reset
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          
          # Otw√≥rz porty
          sudo ufw allow ${{ github.event.inputs.ssh_port }}/tcp comment 'SSH'
          sudo ufw allow 80/tcp comment 'HTTP'
          sudo ufw allow 443/tcp comment 'HTTPS'
          sudo ufw allow 8080/tcp comment 'Alternatywny HTTP'
          sudo ufw allow 3000/tcp comment 'Node.js'
          sudo ufw allow 5000/tcp comment 'Python'
          sudo ufw allow 19999/tcp comment 'Netdata'
          
          # W≈ÇƒÖcz UFW
          sudo ufw --force enable
          
          # Status
          sudo ufw status verbose

      - name: üìÅ Tworzenie struktury katalog√≥w
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # G≈Ç√≥wne katalogi
          sudo mkdir -p /var/www/{html,apps,logs}
          sudo mkdir -p /opt/{scripts,backups}
          sudo mkdir -p /backups/{daily,weekly}
          
          # Uprawnienia
          sudo chown -R $USERNAME:$USERNAME /var/www
          sudo chown -R $USERNAME:$USERNAME /opt
          sudo chown -R $USERNAME:$USERNAME /backups
          
          # Symlinki
          sudo ln -s /var/www /home/$USERNAME/www
          sudo ln -s /opt /home/$USERNAME/opt

      - name: üê≥ Konfiguracja Dockera
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Dodaj u≈ºytkownika do grupy docker
          sudo usermod -aG docker $USERNAME
          
          # Konfiguracja Dockera
          sudo mkdir -p /etc/docker
          cat << EOF | sudo tee /etc/docker/daemon.json
          {
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            },
            "storage-driver": "overlay2",
            "features": {
              "buildkit": true
            }
          }
          EOF
          
          # Restart Dockera
          sudo systemctl restart docker
          sudo systemctl enable docker

      - name: üåê Konfiguracja Nginx
        run: |
          # Testowa strona
          sudo mkdir -p /var/www/html
          cat << EOF | sudo tee /var/www/html/index.html
          <!DOCTYPE html>
          <html>
          <head>
              <title>Ubuntu 24.04 VPS</title>
              <meta charset="UTF-8">
              <style>
                  body { font-family: Arial; text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
                  h1 { font-size: 50px; }
                  .info { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px; }
              </style>
          </head>
          <body>
              <h1>üöÄ Ubuntu 24.04 LTS VPS</h1>
              <div class="info">
                  <p>Serwer dzia≈Ça poprawnie!</p>
                  <p>Tailsecale IP: <strong>$(tailscale ip -4 2>/dev/null || echo 'Oczekiwanie...')</strong></p>
                  <p>Data: $(date)</p>
              </div>
          </body>
          </html>
          EOF
          
          # W≈ÇƒÖcz stronƒô
          sudo systemctl restart nginx
          sudo systemctl enable nginx

      - name: üì¶ Instalacja Tailscale
        run: |
          # Instalacja Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Pod≈ÇƒÖczenie do Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=ubuntu-24-04-${{ github.run_id }} \
            --advertise-tags=tag:github-runner
          
          # Czekaj na IP
          echo "Oczekiwanie na Tailscale IP..."
          for i in {1..10}; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TAILSCALE_IP" ]; then
              echo "Tailscale IP: $TAILSCALE_IP"
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              break
            fi
            echo "Pr√≥ba $i/10..."
            sleep 5
          done

      - name: üìä Instalacja Netdata (monitoring)
        run: |
          # Instalacja Netdata
          wget -O /tmp/netdata-kickstart.sh https://my-netdata.io/kickstart.sh
          sh /tmp/netdata-kickstart.sh --stable-channel --disable-telemetry
          
          # Konfiguracja
          sudo systemctl enable netdata
          sudo systemctl start netdata

      - name: üìã Wy≈õwietl dane dostƒôpowe
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me)
          LOCAL_IP=$(hostname -I | awk '{print $1}')
          
          echo "================================================"
          echo "    üöÄ UBUNTU 24.04 LTS PRZEZ TAILSCALE       "
          echo "================================================"
          echo ""
          echo "üìå DANE SERWERA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üñ•Ô∏è  System: Ubuntu 24.04 LTS (Noble Numbat)"
          echo "üîó Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "üåê Publiczny IP: $PUBLIC_IP"
          echo "üè† Lokalny IP: $LOCAL_IP"
          echo ""
          echo "üë§ DANE U≈ªYTKOWNIKA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "U≈ºytkownik: ${{ env.VPS_USERNAME }}"
          echo "Has≈Ço: ${{ env.VPS_PASSWORD }}"
          echo "Port SSH: ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "üîß KOMENDY DO PO≈ÅƒÑCZENIA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üì° PRZEZ TAILSCALE (ZALECANE - bezpieczne):"
          echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "üåç PRZEZ PUBLICZNY IP:"
          echo "   ssh ${{ env.VPS_USERNAME }}@$PUBLIC_IP -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "üîë KLUCZ PRYWATNY SSH (ED25519):"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "----- BEGIN ED25519 PRIVATE KEY -----"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_ed25519
          echo "----- END ED25519 PRIVATE KEY -----"
          echo ""
          echo "üåê DOSTƒòP PRZEZ PRZEGLƒÑDARKƒò:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "‚Ä¢ Strona testowa: http://$PUBLIC_IP"
          echo "‚Ä¢ Netdata monitoring: http://$PUBLIC_IP:19999"
          echo "‚Ä¢ Przez Tailscale: http://${{ env.TAILSCALE_IP }}:19999"
          echo ""
          echo "üì¶ ZAINSTALOWANE PAKIETY:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "‚úì Docker + Docker Compose"
          echo "‚úì Nginx (port 80, 443)"
          echo "‚úì Node.js + npm"
          echo "‚úì UFW Firewall"
          echo "‚úì Fail2ban"
          echo "‚úì Netdata Monitoring"
          echo "‚úì Tailscale VPN"
          echo ""
          echo "‚ö†Ô∏è  WA≈ªNE: Przy pierwszym logowaniu zmie≈Ñ has≈Ço!"
          echo "   Komenda: passwd"
          echo ""
          echo "================================================"
          echo "‚úÖ VPS gotowy do pracy przez 60 godzin!"
          echo "================================================"

      - name: üîÑ Utrzymywanie po≈ÇƒÖczenia
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me)
          
          echo ""
          echo "‚è≥ Serwer bƒôdzie aktywny przez 60 godzin"
          echo ""
          
          COUNTER=0
          while true; do
            COUNTER=$((COUNTER + 1))
            UPTIME=$(uptime | awk '{print $3}' | tr -d ',')
            
            echo "[$(date)] ‚úÖ Ubuntu 24.04 LTS | Uptime: $UPTIME | Licznik: $COUNTER"
            echo "   Tailscale IP: ${{ env.TAILSCALE_IP }}"
            echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
            echo "   Has≈Ço: ${{ env.VPS_PASSWORD }}"
            echo "   Netdata: http://${{ env.TAILSCALE_IP }}:19999"
            echo "   ---"
            
            # Test po≈ÇƒÖczenia Tailscale co 15 minut
            if [ $((COUNTER % 3)) -eq 0 ]; then
              CURRENT_IP=$(tailscale ip -4 2>/dev/null || echo "Brak")
              echo "   ‚úÖ Tailscale status: $CURRENT_IP"
            fi
            
            sleep 300  # 5 minut
          done

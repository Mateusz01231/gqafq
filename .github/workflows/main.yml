name: üöÄ VPS Ubuntu 24.04 LTS z Tailscale

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Nazwa u≈ºytkownika'
        required: false
        default: 'ubuntu'
      ssh_port:
        description: 'Port SSH'
        required: false
        default: '22'

jobs:
  setup-ubuntu-vps:
    runs-on: ubuntu-24.04
    timeout-minutes: 3600

    steps:
      - name: üì¶ Naprawa i aktualizacja systemu
        run: |
          # Naprawa potencjalnych problem√≥w z pakietami
          sudo dpkg --configure -a
          sudo apt-get update --fix-missing
          sudo apt-get install -f -y
          
          # Aktualizacja systemu
          sudo apt-get update
          sudo apt-get upgrade -y --allow-downgrades
          sudo apt-get dist-upgrade -y
          sudo apt-get autoremove -y --purge
          sudo apt-get autoclean -y

      - name: üì¶ Instalacja podstawowych narzƒôdzi (part 1)
        run: |
          # Instalacja w mniejszych partiach, ≈ºeby uniknƒÖƒá konflikt√≥w
          sudo apt-get install -y \
            openssh-server \
            curl \
            wget \
            git \
            htop \
            neofetch \
            net-tools \
            software-properties-common \
            apt-transport-https \
            ca-certificates \
            gnupg \
            lsb-release \
            unzip \
            zip

      - name: üì¶ Instalacja podstawowych narzƒôdzi (part 2)
        run: |
          # Druga partia pakiet√≥w
          sudo apt-get install -y \
            tmux \
            screen \
            vim \
            nano \
            ufw \
            fail2ban \
            build-essential

      - name: üì¶ Instalacja Dockera (bez konflikt√≥w)
        run: |
          # Usu≈Ñ stare wersje je≈õli istniejƒÖ
          sudo apt-get remove -y docker docker-engine docker.io containerd runc || true
          
          # Instalacja z oficjalnego repozytorium
          sudo install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          sudo chmod a+r /etc/apt/keyrings/docker.gpg
          
          echo \
            "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
            $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          
          # Symbolic link dla docker-compose
          sudo ln -sf /usr/libexec/docker/cli-plugins/docker-compose /usr/local/bin/docker-compose

      - name: üì¶ Instalacja Nginx i Node.js
        run: |
          # Instalacja Nginx
          sudo apt-get install -y nginx
          
          # Instalacja Node.js 20 LTS
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Instalacja dodatkowych narzƒôdzi
          sudo npm install -g npm@latest pm2 yarn

      - name: üîß Konfiguracja SSH
        run: |
          # Backup konfiguracji
          sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
          
          # Konfiguracja SSH
          sudo sed -i 's/^#Port 22/Port ${{ github.event.inputs.ssh_port }}/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin no/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
          sudo sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
          
          # Restart SSH
          sudo systemctl restart sshd

      - name: üë§ Tworzenie u≈ºytkownika
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Generuj losowe has≈Ço
          PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | head -c 16)
          
          # Tworzenie u≈ºytkownika
          sudo useradd -m -s /bin/bash -G sudo $USERNAME 2>/dev/null || true
          echo "$USERNAME:$PASSWORD" | sudo chpasswd
          
          # Dodaj do grup
          sudo usermod -aG docker,adm $USERNAME
          
          # Sudo bez has≈Ça
          echo "$USERNAME ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/$USERNAME
          
          # Zapisz dane
          echo "VPS_USERNAME=$USERNAME" >> $GITHUB_ENV
          echo "VPS_PASSWORD=$PASSWORD" >> $GITHUB_ENV

      - name: üîë Generowanie kluczy SSH
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          # Tworzenie katalogu .ssh
          sudo mkdir -p /home/$USERNAME/.ssh
          sudo chmod 700 /home/$USERNAME/.ssh
          
          # Generowanie kluczy
          sudo ssh-keygen -t ed25519 -f /home/$USERNAME/.ssh/id_ed25519 -N "" -C "$USERNAME@ubuntu-24.04" -q
          
          # Autoryzacja
          sudo cp /home/$USERNAME/.ssh/id_ed25519.pub /home/$USERNAME/.ssh/authorized_keys
          sudo chmod 600 /home/$USERNAME/.ssh/authorized_keys
          sudo chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

      - name: üî• Konfiguracja firewalla
        run: |
          # Reset UFW je≈õli jest problem
          sudo ufw --force reset || true
          
          # Podstawowa konfiguracja
          sudo ufw default deny incoming
          sudo ufw default allow outgoing
          
          # Otw√≥rz porty
          sudo ufw allow ${{ github.event.inputs.ssh_port }}/tcp
          sudo ufw allow 80/tcp
          sudo ufw allow 443/tcp
          
          # W≈ÇƒÖcz UFW
          echo "y" | sudo ufw enable
          
          # Status
          sudo ufw status verbose

      - name: üìÅ Tworzenie katalog√≥w
        run: |
          USERNAME="${{ github.event.inputs.username }}"
          
          sudo mkdir -p /var/www/html
          sudo mkdir -p /opt/scripts
          sudo mkdir -p /backups
          
          sudo chown -R $USERNAME:$USERNAME /var/www 2>/dev/null || true
          sudo chown -R $USERNAME:$USERNAME /opt 2>/dev/null || true
          sudo chown -R $USERNAME:$USERNAME /backups 2>/dev/null || true
          
          # Testowa strona
          echo "<h1>Ubuntu 24.04 VPS Dzia≈Ça!</h1>" | sudo tee /var/www/html/index.html

      - name: üì¶ Instalacja Tailscale
        run: |
          # Instalacja Tailscale
          curl -fsSL https://tailscale.com/install.sh | sh
          
          # Pod≈ÇƒÖczenie do Tailscale
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=ubuntu-24-04-${{ github.run_id }} \
            --accept-routes \
            --accept-dns=false
          
          # Czekaj na IP
          for i in {1..15}; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "")
            if [ -n "$TAILSCALE_IP" ]; then
              echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
              echo "‚úÖ Tailscale IP: $TAILSCALE_IP"
              break
            fi
            echo "Oczekiwanie na Tailscale IP... ($i/15)"
            sleep 5
          done

      - name: üìã Wy≈õwietl dane dostƒôpowe
        run: |
          PUBLIC_IP=$(curl -s ifconfig.me || curl -s icanhazip.com || echo "Nieznany")
          
          echo "================================================"
          echo "    üöÄ UBUNTU 24.04 LTS GOTOWY                "
          echo "================================================"
          echo ""
          echo "üìå DANE SERWERA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üñ•Ô∏è  System: Ubuntu 24.04 LTS"
          echo "üîó Tailscale IP: ${{ env.TAILSCALE_IP }}"
          echo "üåê Publiczny IP: $PUBLIC_IP"
          echo ""
          echo "üë§ DANE U≈ªYTKOWNIKA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "U≈ºytkownik: ${{ env.VPS_USERNAME }}"
          echo "Has≈Ço: ${{ env.VPS_PASSWORD }}"
          echo "Port SSH: ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "üîß KOMENDY DO PO≈ÅƒÑCZENIA:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          echo "üì° PRZEZ TAILSCALE:"
          echo "   ssh ${{ env.VPS_USERNAME }}@${{ env.TAILSCALE_IP }} -p ${{ github.event.inputs.ssh_port }}"
          echo ""
          echo "üîë KLUCZ PRYWATNY SSH:"
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
          sudo cat /home/${{ env.VPS_USERNAME }}/.ssh/id_ed25519
          echo ""
          echo "================================================"

      - name: üîÑ Utrzymywanie po≈ÇƒÖczenia
        run: |
          echo "‚è≥ Serwer aktywny przez 60 godzin"
          echo ""
          
          while true; do
            TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || echo "${{ env.TAILSCALE_IP }}")
            echo "[$(date)] ‚úÖ Ubuntu 24.04 | Tailscale: $TAILSCALE_IP"
            echo "   ssh ${{ env.VPS_USERNAME }}@$TAILSCALE_IP -p ${{ github.event.inputs.ssh_port }}"
            echo "   Has≈Ço: ${{ env.VPS_PASSWORD }}"
            echo "   ---"
            sleep 300
          done
